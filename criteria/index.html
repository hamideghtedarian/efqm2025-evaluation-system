<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>فرم ارزیابی EFQM 2025</title>
  <style>
    body{font-family: Vazirmatn, Tahoma; background:#f6f8fb; padding:20px; color:#222;}
    .card{background:#fff; border-radius:10px; box-shadow:0 4px 12px rgba(0,0,0,0.08); padding:16px; margin-bottom:18px;}
    label{font-weight:600; display:block; margin-top:8px;}
    input, select, textarea{width:100%; padding:8px; border:1px solid #ccc; border-radius:8px; margin-top:6px;}
    textarea{min-height:70px;}
    button{background:#004aad; color:white; border:none; padding:10px 18px; border-radius:8px; cursor:pointer;}
    button:hover{background:#003880;}
    button.secondary{background:#6c757d;}
    button.danger{background:#b32424;}
    table{width:100%; border-collapse:collapse; margin-top:10px;}
    th, td{padding:8px; border:1px solid #e1e5eb;}
    .small{font-size:13px; color:#555;}
    .badge{background:#e6f0ff; color:#003366; padding:4px 8px; border-radius:12px; font-weight:600;}
  </style>
</head>
<body>
<button onclick="window.open('../help/criteria.html', '_blank')">❓ راهنما</button>

  <div class="card">
    <h2>🧭 شناسنامه ارزیابی</h2>
    <label>نام سازمان</label>
    <input id="orgName" placeholder="مثلاً شرکت فولاد آریا" />

    <div style="display:flex; gap:10px; flex-wrap:wrap;">
      <div style="flex:1;">
        <label>تاریخ ارزیابی</label>
        <input type="date" id="evalDate" />
      </div>
      <div style="flex:1;">
        <label>تیم ارزیابی (با کاما جدا کنید)</label>
        <input id="evalTeam" placeholder="مثلاً علی، رضا، نسرین" />
      </div>
    </div>

    <label style="margin-top:10px;">مسیر مدل EFQM</label>
    <input id="modelPath" value="../data/efqm2025.json" />
  </div>

  <div class="card">
    <h2>📋 ارزیابی زیرمعیارها</h2>
    <label>انتخاب زیرمعیار</label>
    <select id="subSelect"><option>در حال بارگذاری...</option></select>
    <div id="criterionTooltip" style="margin-top:10px;"></div>

    <label>امتیاز زیرمعیار (۰–۱۰۰)</label>
    <input type="number" id="score" min="0" max="100" />

    <label>Results (نتایج)</label>
    <textarea id="results"></textarea>

    <label>Approach (رویکرد)</label>
    <textarea id="approach"></textarea>

    <label>Deployment (جاری‌سازی)</label>
    <textarea id="deployment"></textarea>

    <label>Assessment & Refinement (ارزیابی و بهبود)</label>
    <textarea id="refinement"></textarea>

    <label>نقاط قوت (هر خط یک مورد)</label>
    <textarea id="strengths"></textarea>

    <label>فرصت‌های بهبود (هر خط یک مورد)</label>
    <textarea id="opportunities"></textarea>

    <div style="margin-top:10px;">
      <button onclick="addOrUpdateEntry()">💾 افزودن/بروزرسانی</button>
      <button class="secondary" onclick="clearEntry()">پاک کردن</button>
    </div>
  </div>

  <div class="card">
    <h2>📊 فهرست ارزیابی‌ها</h2>
    <div id="summaryBadges" style="margin-bottom:10px;"></div>
    <div id="entriesWrap">هنوز داده‌ای ثبت نشده است.</div>
  </div>

  <div class="card">
    <h2>💾 ذخیره و خروجی</h2>
    <button onclick="saveLocal()">ذخیره محلی</button>
    <button onclick="downloadJSON()">دانلود فایل JSON</button>
    <input type="file" id="loadFileInput" style="margin-top:8px;" />
    <hr style="margin:10px 0;">
    <input id="ghToken" placeholder="توکن GitHub (اختیاری)" />
    <input id="ghFilename" placeholder="نام فایل در GitHub (مثلاً foolad-arya.json)" style="margin-top:6px;" />
    <button onclick="saveToGitHub()">📡 ذخیره در GitHub</button>
    <div class="small">پیشنهاد: از GitHub Actions برای امنیت بیشتر استفاده کنید.</div>

    <h3 style="margin-top:12px;">📄 پیش‌نمایش داده‌ها</h3>
    <pre id="output" style="background:#f2f6fb; padding:10px; border-radius:8px; max-height:300px; overflow:auto;">{}</pre>
  </div>

<script>
let model = null;
let entries = [];
let editingIndex = null;

async function loadModel() {
  const path = document.getElementById('modelPath').value;
  try {
    const resp = await fetch(path);
    model = await resp.json();
    populateSubcriteria();
  } catch (err) {
    alert('خطا در بارگذاری مدل EFQM: ' + err.message);
  }
}

/* ======= پر کردن لیست زیرمعیارها با Tooltip ======= */
function populateSubcriteria(){
  const sel = document.getElementById('subSelect');
  sel.innerHTML = '';
  if(!model || !Array.isArray(model.criteria)) {
    sel.innerHTML = '<option>مدل نامعتبر</option>';
    return;
  }
  model.criteria.forEach(c=>{
    if(Array.isArray(c.subcriteria)) {
      const group = document.createElement('optgroup');
      group.label = `${c.id} - ${c.title_fa}`;
      c.subcriteria.forEach(sc=>{
        const opt = document.createElement('option');
        opt.value = sc.id;
        opt.dataset.criterionId = c.id;
        opt.dataset.description = sc.description || "";
        opt.dataset.title_en = sc.title_en || "";
        opt.dataset.title_fa = sc.title_fa || "";
        opt.textContent = `${sc.id} - ${sc.title_fa}`;
        group.appendChild(opt);
      });
      sel.appendChild(group);
    }
  });
  sel.addEventListener('change', showTooltipForSelected);
  if(sel.options.length > 0){ sel.selectedIndex = 0; showTooltipForSelected(); }
}

/* ======= نمایش Tooltip ======= */
function showTooltipForSelected(){
  const sel = document.getElementById('subSelect');
  const selected = sel.selectedOptions[0];
  const tooltip = document.getElementById('criterionTooltip');
  if(!selected || !tooltip) return;
  const desc = selected.dataset.description || "";
  const titleEn = selected.dataset.title_en || "";
  const titleFa = selected.dataset.title_fa || "";
  tooltip.innerHTML = `
    <div style="background:#eaf1ff;border:1px solid #bcd3ff;border-radius:10px;padding:10px;margin-top:8px;">
      <b style="color:#003366;">${selected.value} — ${titleEn}</b><br>
      <span style="font-weight:600;">${titleFa}</span><br>
      <small>${desc}</small>
    </div>`;
}

/* ======= ثبت زیرمعیار ======= */
function addOrUpdateEntry(){
  const sub = document.getElementById('subSelect').selectedOptions[0];
  if(!sub) return alert('لطفاً زیرمعیار را انتخاب کنید.');
  const e = {
    subId: sub.value,
    criterionId: Number(sub.dataset.criterionId),
    score: Number(document.getElementById('score').value) || null,
    radar: {
      results: results.value, approach: approach.value,
      deployment: deployment.value, refinement: refinement.value
    },
    strengths: strengths.value.split('\n').filter(Boolean),
    opportunities: opportunities.value.split('\n').filter(Boolean),
    updated: new Date().toISOString()
  };
  if(editingIndex!=null) entries[editingIndex]=e; else entries.push(e);
  editingIndex=null; renderEntries(); clearEntry();
}

/* ======= پاکسازی ======= */
function clearEntry(){
  ['score','results','approach','deployment','refinement','strengths','opportunities']
  .forEach(id=>document.getElementById(id).value="");
}

/* ======= نمایش داده‌ها ======= */
function renderEntries(){
  const wrap=document.getElementById('entriesWrap');
  if(entries.length===0){wrap.innerHTML='<div class="small">هنوز داده‌ای ثبت نشده است.</div>'; updateOutput(); return;}
  const byCrit={};
  entries.forEach((e,i)=>{(byCrit[e.criterionId]??=[]).push({...e,idx:i});});
  let html='<table><tr><th>معیار</th><th>زیرمعیار</th><th>امتیاز</th><th>نقاط قوت</th><th>فرصت‌ها</th><th>عملیات</th></tr>';
  for(const cid in byCrit){
    byCrit[cid].forEach(it=>{
      html+=`<tr><td>${cid}</td><td>${it.subId}</td><td>${it.score??'-'}</td>
        <td>${it.strengths.join('<br>')}</td><td>${it.opportunities.join('<br>')}</td>
        <td><button onclick="editEntry(${it.idx})">✏</button>
        <button class="danger" onclick="deleteEntry(${it.idx})">🗑</button></td></tr>`;
    });
    const avg=computeAvg(cid);
    html+=`<tr style="background:#f9fbff;font-weight:600;"><td colspan="2">میانگین معیار ${cid}</td><td>${avg?.toFixed(1)??'-'}</td><td colspan="3"></td></tr>`;
  }
  html+='</table>'; wrap.innerHTML=html; renderBadges(); updateOutput();
}

/* ======= میانگین ======= */
function computeAvg(cid){
  const list=entries.filter(e=>String(e.criterionId)===String(cid)&&!isNaN(e.score));
  if(list.length===0) return null;
  return list.reduce((a,b)=>a+b.score,0)/list.length;
}

/* ======= خلاصه ======= */
function renderBadges(){
  const el=document.getElementById('summaryBadges');
  el.innerHTML='';
  [...new Set(entries.map(e=>e.criterionId))].forEach(cid=>{
    const avg=computeAvg(cid);
    const span=document.createElement('span');
    span.className='badge';
    span.textContent=`معیار ${cid}: ${avg?.toFixed(1)??'-'}`;
    el.appendChild(span); el.appendChild(document.createTextNode(' '));
  });
}

/* ======= ویرایش/حذف ======= */
function editEntry(i){const e=entries[i];editingIndex=i;
  document.getElementById('score').value=e.score??'';
  results.value=e.radar.results; approach.value=e.radar.approach;
  deployment.value=e.radar.deployment; refinement.value=e.radar.refinement;
  strengths.value=e.strengths.join('\n'); opportunities.value=e.opportunities.join('\n');
}
function deleteEntry(i){if(confirm('حذف شود؟')){entries.splice(i,1);renderEntries();}}

/* ======= JSON نهایی ======= */
function buildJSON(){
  const meta={organization:orgName.value,evaluation_date:evalDate.value||new Date().toISOString().slice(0,10),
    evaluator_team:evalTeam.value.split(',').map(s=>s.trim()).filter(Boolean),
    model_version:'EFQM 2025',generated_at:new Date().toISOString()};
  const grouped={}; entries.forEach(e=>(grouped[e.criterionId]??=[]).push(e));
  const criteria=Object.keys(grouped).map(cid=>({criterion_id:Number(cid),average_score:computeAvg(cid),subcriteria:grouped[cid]}));
  return {metadata:meta,criteria};
}

/* ======= خروجی ======= */
function updateOutput(){output.textContent=JSON.stringify(buildJSON(),null,2);}
function saveLocal(){localStorage.setItem('efqm_eval',JSON.stringify(buildJSON()));alert('ذخیره محلی انجام شد');}
function downloadJSON(){
  const blob=new Blob([JSON.stringify(buildJSON(),null,2)],{type:'application/json'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);
  a.download=(orgName.value||'evaluation')+'.json';a.click();
}
document.getElementById('loadFileInput').addEventListener('change',ev=>{
  const f=ev.target.files[0];if(!f)return;const r=new FileReader();
  r.onload=()=>{try{const j=JSON.parse(r.result);entries=j.criteria.flatMap(c=>c.subcriteria||[]);renderEntries();alert('فایل بارگذاری شد.');}
  catch(e){alert('خطا در فایل: '+e.message);}};r.readAsText(f,'utf-8');
});

/* ======= ذخیره در GitHub ======= */
async function saveToGitHub(){
  const token=ghToken.value.trim(),file=ghFilename.value.trim();
  if(!token||!file)return alert('توکن یا نام فایل وارد نشده است.');
  const contentB64=btoa(unescape(encodeURIComponent(JSON.stringify(buildJSON(),null,2))));
  const api=`https://api.github.com/repos/hamideghtedarian/efqm2025-evaluation-system/contents/data/companies/${file}`;
  let sha=null;
  const head=await fetch(api,{headers:{Authorization:'token '+token}});
  if(head.status===200){const j=await head.json();sha=j.sha;}
  const res=await fetch(api,{method:'PUT',headers:{Authorization:'token '+token,'Content-Type':'application/json'},
    body:JSON.stringify({message:'Add/update evaluation',content:contentB64,branch:'main',...(sha?{sha}:{} )})});
  alert(res.ok?'✅ ذخیره در GitHub انجام شد.':'❌ خطا در GitHub');
}

loadModel();
</script>
</body>
</html>
