<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ÙØ±Ù… Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ EFQM 2025</title>
  <style>
    body{font-family: Vazirmatn, Tahoma; background:#f6f8fb; padding:20px; color:#222;}
    .card{background:#fff; border-radius:10px; box-shadow:0 4px 12px rgba(0,0,0,0.08); padding:16px; margin-bottom:18px;}
    label{font-weight:600; display:block; margin-top:8px;}
    input, select, textarea{width:100%; padding:8px; border:1px solid #ccc; border-radius:8px; margin-top:6px;}
    textarea{min-height:70px;}
    button{background:#004aad; color:white; border:none; padding:10px 18px; border-radius:8px; cursor:pointer;}
    button:hover{background:#003880;}
    button.secondary{background:#6c757d;}
    button.danger{background:#b32424;}
    table{width:100%; border-collapse:collapse; margin-top:10px;}
    th, td{padding:8px; border:1px solid #e1e5eb;}
    .small{font-size:13px; color:#555;}
    .badge{background:#e6f0ff; color:#003366; padding:4px 8px; border-radius:12px; font-weight:600;}
  </style>
</head>
<body>
<button onclick="window.open('../help/criteria.html', '_blank')">â“ Ø±Ø§Ù‡Ù†Ù…Ø§</button>

  <div class="card">
    <h2>ğŸ§­ Ø´Ù†Ø§Ø³Ù†Ø§Ù…Ù‡ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ</h2>
    <label>Ù†Ø§Ù… Ø³Ø§Ø²Ù…Ø§Ù†</label>
    <input id="orgName" placeholder="Ù…Ø«Ù„Ø§Ù‹ Ø´Ø±Ú©Øª ÙÙˆÙ„Ø§Ø¯ Ø¢Ø±ÛŒØ§" />

    <div style="display:flex; gap:10px; flex-wrap:wrap;">
      <div style="flex:1;">
        <label>ØªØ§Ø±ÛŒØ® Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ</label>
        <input type="date" id="evalDate" />
      </div>
      <div style="flex:1;">
        <label>ØªÛŒÙ… Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ (Ø¨Ø§ Ú©Ø§Ù…Ø§ Ø¬Ø¯Ø§ Ú©Ù†ÛŒØ¯)</label>
        <input id="evalTeam" placeholder="Ù…Ø«Ù„Ø§Ù‹ Ø¹Ù„ÛŒØŒ Ø±Ø¶Ø§ØŒ Ù†Ø³Ø±ÛŒÙ†" />
      </div>
    </div>

    <label style="margin-top:10px;">Ù…Ø³ÛŒØ± Ù…Ø¯Ù„ EFQM</label>
    <input id="modelPath" value="../data/efqm2025.json" />
  </div>

  <div class="card">
    <h2>ğŸ“‹ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ø²ÛŒØ±Ù…Ø¹ÛŒØ§Ø±Ù‡Ø§</h2>
    <label>Ø§Ù†ØªØ®Ø§Ø¨ Ø²ÛŒØ±Ù…Ø¹ÛŒØ§Ø±</label>
    <select id="subSelect"><option>Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</option></select>
    <div id="criterionTooltip" style="margin-top:10px;"></div>

    <label>Ø§Ù…ØªÛŒØ§Ø² Ø²ÛŒØ±Ù…Ø¹ÛŒØ§Ø± (Û°â€“Û±Û°Û°)</label>
    <input type="number" id="score" min="0" max="100" />

    <label>Results (Ù†ØªØ§ÛŒØ¬)</label>
    <textarea id="results"></textarea>

    <label>Approach (Ø±ÙˆÛŒÚ©Ø±Ø¯)</label>
    <textarea id="approach"></textarea>

    <label>Deployment (Ø¬Ø§Ø±ÛŒâ€ŒØ³Ø§Ø²ÛŒ)</label>
    <textarea id="deployment"></textarea>

    <label>Assessment & Refinement (Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ùˆ Ø¨Ù‡Ø¨ÙˆØ¯)</label>
    <textarea id="refinement"></textarea>

    <label>Ù†Ù‚Ø§Ø· Ù‚ÙˆØª (Ù‡Ø± Ø®Ø· ÛŒÚ© Ù…ÙˆØ±Ø¯)</label>
    <textarea id="strengths"></textarea>

    <label>ÙØ±ØµØªâ€ŒÙ‡Ø§ÛŒ Ø¨Ù‡Ø¨ÙˆØ¯ (Ù‡Ø± Ø®Ø· ÛŒÚ© Ù…ÙˆØ±Ø¯)</label>
    <textarea id="opportunities"></textarea>

    <div style="margin-top:10px;">
      <button onclick="addOrUpdateEntry()">ğŸ’¾ Ø§ÙØ²ÙˆØ¯Ù†/Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ</button>
      <button class="secondary" onclick="clearEntry()">Ù¾Ø§Ú© Ú©Ø±Ø¯Ù†</button>
    </div>
  </div>

  <div class="card">
    <h2>ğŸ“Š ÙÙ‡Ø±Ø³Øª Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒâ€ŒÙ‡Ø§</h2>
    <div id="summaryBadges" style="margin-bottom:10px;"></div>
    <div id="entriesWrap">Ù‡Ù†ÙˆØ² Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</div>
  </div>

  <div class="card">
    <h2>ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡ Ùˆ Ø®Ø±ÙˆØ¬ÛŒ</h2>
    <button onclick="saveLocal()">Ø°Ø®ÛŒØ±Ù‡ Ù…Ø­Ù„ÛŒ</button>
    <button onclick="downloadJSON()">Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙØ§ÛŒÙ„ JSON</button>
    <input type="file" id="loadFileInput" style="margin-top:8px;" />
    <hr style="margin:10px 0;">
    <input id="ghToken" placeholder="ØªÙˆÚ©Ù† GitHub (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)" />
    <input id="ghFilename" placeholder="Ù†Ø§Ù… ÙØ§ÛŒÙ„ Ø¯Ø± GitHub (Ù…Ø«Ù„Ø§Ù‹ foolad-arya.json)" style="margin-top:6px;" />
    <button onclick="saveToGitHub()">ğŸ“¡ Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± GitHub</button>
    <div class="small">Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯: Ø§Ø² GitHub Actions Ø¨Ø±Ø§ÛŒ Ø§Ù…Ù†ÛŒØª Ø¨ÛŒØ´ØªØ± Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.</div>

    <h3 style="margin-top:12px;">ğŸ“„ Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§</h3>
    <pre id="output" style="background:#f2f6fb; padding:10px; border-radius:8px; max-height:300px; overflow:auto;">{}</pre>
  </div>

<script>
let model = null;
let entries = [];
let editingIndex = null;

async function loadModel() {
  const path = document.getElementById('modelPath').value;
  try {
    const resp = await fetch(path);
    model = await resp.json();
    populateSubcriteria();
  } catch (err) {
    alert('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…Ø¯Ù„ EFQM: ' + err.message);
  }
}

/* ======= Ù¾Ø± Ú©Ø±Ø¯Ù† Ù„ÛŒØ³Øª Ø²ÛŒØ±Ù…Ø¹ÛŒØ§Ø±Ù‡Ø§ Ø¨Ø§ Tooltip ======= */
function populateSubcriteria(){
  const sel = document.getElementById('subSelect');
  sel.innerHTML = '';
  if(!model || !Array.isArray(model.criteria)) {
    sel.innerHTML = '<option>Ù…Ø¯Ù„ Ù†Ø§Ù…Ø¹ØªØ¨Ø±</option>';
    return;
  }
  model.criteria.forEach(c=>{
    if(Array.isArray(c.subcriteria)) {
      const group = document.createElement('optgroup');
      group.label = `${c.id} - ${c.title_fa}`;
      c.subcriteria.forEach(sc=>{
        const opt = document.createElement('option');
        opt.value = sc.id;
        opt.dataset.criterionId = c.id;
        opt.dataset.description = sc.description || "";
        opt.dataset.title_en = sc.title_en || "";
        opt.dataset.title_fa = sc.title_fa || "";
        opt.textContent = `${sc.id} - ${sc.title_fa}`;
        group.appendChild(opt);
      });
      sel.appendChild(group);
    }
  });
  sel.addEventListener('change', showTooltipForSelected);
  if(sel.options.length > 0){ sel.selectedIndex = 0; showTooltipForSelected(); }
}

/* ======= Ù†Ù…Ø§ÛŒØ´ Tooltip ======= */
function showTooltipForSelected(){
  const sel = document.getElementById('subSelect');
  const selected = sel.selectedOptions[0];
  const tooltip = document.getElementById('criterionTooltip');
  if(!selected || !tooltip) return;
  const desc = selected.dataset.description || "";
  const titleEn = selected.dataset.title_en || "";
  const titleFa = selected.dataset.title_fa || "";
  tooltip.innerHTML = `
    <div style="background:#eaf1ff;border:1px solid #bcd3ff;border-radius:10px;padding:10px;margin-top:8px;">
      <b style="color:#003366;">${selected.value} â€” ${titleEn}</b><br>
      <span style="font-weight:600;">${titleFa}</span><br>
      <small>${desc}</small>
    </div>`;
}

/* ======= Ø«Ø¨Øª Ø²ÛŒØ±Ù…Ø¹ÛŒØ§Ø± ======= */
function addOrUpdateEntry(){
  const sub = document.getElementById('subSelect').selectedOptions[0];
  if(!sub) return alert('Ù„Ø·ÙØ§Ù‹ Ø²ÛŒØ±Ù…Ø¹ÛŒØ§Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.');
  const e = {
    subId: sub.value,
    criterionId: Number(sub.dataset.criterionId),
    score: Number(document.getElementById('score').value) || null,
    radar: {
      results: results.value, approach: approach.value,
      deployment: deployment.value, refinement: refinement.value
    },
    strengths: strengths.value.split('\n').filter(Boolean),
    opportunities: opportunities.value.split('\n').filter(Boolean),
    updated: new Date().toISOString()
  };
  if(editingIndex!=null) entries[editingIndex]=e; else entries.push(e);
  editingIndex=null; renderEntries(); clearEntry();
}

/* ======= Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ ======= */
function clearEntry(){
  ['score','results','approach','deployment','refinement','strengths','opportunities']
  .forEach(id=>document.getElementById(id).value="");
}

/* ======= Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ ======= */
function renderEntries(){
  const wrap=document.getElementById('entriesWrap');
  if(entries.length===0){wrap.innerHTML='<div class="small">Ù‡Ù†ÙˆØ² Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</div>'; updateOutput(); return;}
  const byCrit={};
  entries.forEach((e,i)=>{(byCrit[e.criterionId]??=[]).push({...e,idx:i});});
  let html='<table><tr><th>Ù…Ø¹ÛŒØ§Ø±</th><th>Ø²ÛŒØ±Ù…Ø¹ÛŒØ§Ø±</th><th>Ø§Ù…ØªÛŒØ§Ø²</th><th>Ù†Ù‚Ø§Ø· Ù‚ÙˆØª</th><th>ÙØ±ØµØªâ€ŒÙ‡Ø§</th><th>Ø¹Ù…Ù„ÛŒØ§Øª</th></tr>';
  for(const cid in byCrit){
    byCrit[cid].forEach(it=>{
      html+=`<tr><td>${cid}</td><td>${it.subId}</td><td>${it.score??'-'}</td>
        <td>${it.strengths.join('<br>')}</td><td>${it.opportunities.join('<br>')}</td>
        <td><button onclick="editEntry(${it.idx})">âœ</button>
        <button class="danger" onclick="deleteEntry(${it.idx})">ğŸ—‘</button></td></tr>`;
    });
    const avg=computeAvg(cid);
    html+=`<tr style="background:#f9fbff;font-weight:600;"><td colspan="2">Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ù…Ø¹ÛŒØ§Ø± ${cid}</td><td>${avg?.toFixed(1)??'-'}</td><td colspan="3"></td></tr>`;
  }
  html+='</table>'; wrap.innerHTML=html; renderBadges(); updateOutput();
}

/* ======= Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† ======= */
function computeAvg(cid){
  const list=entries.filter(e=>String(e.criterionId)===String(cid)&&!isNaN(e.score));
  if(list.length===0) return null;
  return list.reduce((a,b)=>a+b.score,0)/list.length;
}

/* ======= Ø®Ù„Ø§ØµÙ‡ ======= */
function renderBadges(){
  const el=document.getElementById('summaryBadges');
  el.innerHTML='';
  [...new Set(entries.map(e=>e.criterionId))].forEach(cid=>{
    const avg=computeAvg(cid);
    const span=document.createElement('span');
    span.className='badge';
    span.textContent=`Ù…Ø¹ÛŒØ§Ø± ${cid}: ${avg?.toFixed(1)??'-'}`;
    el.appendChild(span); el.appendChild(document.createTextNode(' '));
  });
}

/* ======= ÙˆÛŒØ±Ø§ÛŒØ´/Ø­Ø°Ù ======= */
function editEntry(i){const e=entries[i];editingIndex=i;
  document.getElementById('score').value=e.score??'';
  results.value=e.radar.results; approach.value=e.radar.approach;
  deployment.value=e.radar.deployment; refinement.value=e.radar.refinement;
  strengths.value=e.strengths.join('\n'); opportunities.value=e.opportunities.join('\n');
}
function deleteEntry(i){if(confirm('Ø­Ø°Ù Ø´ÙˆØ¯ØŸ')){entries.splice(i,1);renderEntries();}}

/* ======= JSON Ù†Ù‡Ø§ÛŒÛŒ ======= */
function buildJSON(){
  const meta={organization:orgName.value,evaluation_date:evalDate.value||new Date().toISOString().slice(0,10),
    evaluator_team:evalTeam.value.split(',').map(s=>s.trim()).filter(Boolean),
    model_version:'EFQM 2025',generated_at:new Date().toISOString()};
  const grouped={}; entries.forEach(e=>(grouped[e.criterionId]??=[]).push(e));
  const criteria=Object.keys(grouped).map(cid=>({criterion_id:Number(cid),average_score:computeAvg(cid),subcriteria:grouped[cid]}));
  return {metadata:meta,criteria};
}

/* ======= Ø®Ø±ÙˆØ¬ÛŒ ======= */
function updateOutput(){output.textContent=JSON.stringify(buildJSON(),null,2);}
function saveLocal(){localStorage.setItem('efqm_eval',JSON.stringify(buildJSON()));alert('Ø°Ø®ÛŒØ±Ù‡ Ù…Ø­Ù„ÛŒ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯');}
function downloadJSON(){
  const blob=new Blob([JSON.stringify(buildJSON(),null,2)],{type:'application/json'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);
  a.download=(orgName.value||'evaluation')+'.json';a.click();
}
document.getElementById('loadFileInput').addEventListener('change',ev=>{
  const f=ev.target.files[0];if(!f)return;const r=new FileReader();
  r.onload=()=>{try{const j=JSON.parse(r.result);entries=j.criteria.flatMap(c=>c.subcriteria||[]);renderEntries();alert('ÙØ§ÛŒÙ„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯.');}
  catch(e){alert('Ø®Ø·Ø§ Ø¯Ø± ÙØ§ÛŒÙ„: '+e.message);}};r.readAsText(f,'utf-8');
});

/* ======= Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± GitHub ======= */
async function saveToGitHub(){
  const token=ghToken.value.trim(),file=ghFilename.value.trim();
  if(!token||!file)return alert('ØªÙˆÚ©Ù† ÛŒØ§ Ù†Ø§Ù… ÙØ§ÛŒÙ„ ÙˆØ§Ø±Ø¯ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.');
  const contentB64=btoa(unescape(encodeURIComponent(JSON.stringify(buildJSON(),null,2))));
  const api=`https://api.github.com/repos/hamideghtedarian/efqm2025-evaluation-system/contents/data/companies/${file}`;
  let sha=null;
  const head=await fetch(api,{headers:{Authorization:'token '+token}});
  if(head.status===200){const j=await head.json();sha=j.sha;}
  const res=await fetch(api,{method:'PUT',headers:{Authorization:'token '+token,'Content-Type':'application/json'},
    body:JSON.stringify({message:'Add/update evaluation',content:contentB64,branch:'main',...(sha?{sha}:{} )})});
  alert(res.ok?'âœ… Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± GitHub Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯.':'âŒ Ø®Ø·Ø§ Ø¯Ø± GitHub');
}

loadModel();
</script>
</body>
</html>
