<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ÙØ±Ù… Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ EFQM 2025 â€” ÙˆØ±Ú˜Ù† Ø¨Ø±Ù†Ø¯</title>

  <style>
    body { font-family: "Vazirmatn", sans-serif, Tahoma, Arial; background:#f7f9fc; color:#222; margin:0; padding:18px; direction:rtl; }
    .container { max-width:1100px; margin:0 auto; }
    .brand-banner img { max-width:100%; height:auto; border-radius:10px; box-shadow:0 4px 12px rgba(0,0,0,0.08); }
    .brand-logo img { width:120px; display:block; margin:8px auto; }
    h1 { text-align:center; color:#004080; margin:14px 0; }
    .card { background:#fff; border-radius:12px; padding:16px; box-shadow:0 2px 6px rgba(0,0,0,0.06); margin:16px 0; }
    label { display:block; font-weight:700; margin-top:10px; }
    input[type="text"], input[type="date"], input[type="number"], select, textarea {
      width:100%; padding:8px; border-radius:8px; border:1px solid #d0d6dc; margin-top:6px;
    }
    textarea { min-height:80px; resize:vertical; }
    .row { display:flex; gap:12px; flex-wrap:wrap; }
    .col { flex:1 1 300px; min-width:240px; }
    button { background:#004080; color:#fff; border:none; padding:8px 12px; border-radius:8px; cursor:pointer; }
    button.secondary { background:#6c757d; }
    button.danger { background:#c0392b; }
    ul { padding-right:16px; }
    .list-item { padding:8px 10px; border:1px solid #eef0f2; margin:8px 0; border-radius:8px; display:flex; justify-content:space-between; align-items:center; gap:8px; }
    .actions button { margin-left:6px; }
    #output { background:#f2f4f7; padding:10px; border-radius:8px; white-space:pre-wrap; max-height:300px; overflow:auto; }
    footer { text-align:center; color:#666; margin:18px 0; font-size:14px; }
    .small { font-size:13px; color:#666; margin-top:8px; }
  </style>

  <!-- html2pdf bundle for PDF export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
</head>
<body>
  <div class="container">

    <!-- Brand -->
    <div class="card brand-banner" id="brandBannerWrap">
      <img src="https://raw.githubusercontent.com/hamideghtedarian/hamideghtedarian/main/banner.png"
           alt="Brand Banner" id="brandBannerImg">
    </div>
    <div class="card brand-logo" id="brandLogoWrap">
      <img src="https://raw.githubusercontent.com/hamideghtedarian/hamideghtedarian/main/logo.png"
           alt="Brand Logo" id="brandLogoImg">
    </div>

    <h1>Ø³Ø§Ù…Ø§Ù†Ù‡ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ EFQM 2025 â€” Ù†Ø³Ø®Ù‡ ÙØ§Ø±Ø³ÛŒ</h1>

    <!-- File load/save -->
    <div class="card">
      <div class="row">
        <div class="col">
          <label>Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ÙØ§ÛŒÙ„ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ (JSON)</label>
          <input type="file" id="fileInput" accept=".json" />
          <div class="small">Ø¨Ø§ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒØŒ Ù…Ø­ØªÙˆØ§ÛŒ ÙØ§ÛŒÙ„ Ø¯Ø± ÙØ±Ù… Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯Ù‡ Ùˆ Ù‚Ø§Ø¨Ù„ ÙˆÛŒØ±Ø§ÛŒØ´ Ø§Ø³Øª.</div>
        </div>

        <div class="col">
          <label>Ø°Ø®ÛŒØ±Ù‡/Ø®Ø±ÙˆØ¬ÛŒ</label>
          <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:6px;">
            <button onclick="downloadJSON()">ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡ JSON</button>
            <button onclick="downloadWord()">ğŸ“„ Ø¯Ø§Ù†Ù„ÙˆØ¯ Word (.doc)</button>
            <button onclick="exportPDF()">ğŸ“• ØªÙˆÙ„ÛŒØ¯ PDF Ø±Ø³Ù…ÛŒ</button>
            <button class="secondary" onclick="clearAll()">âœ– Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ÙØ±Ù…</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Organization info -->
    <div class="card">
      <label>Ù†Ø§Ù… Ø³Ø§Ø²Ù…Ø§Ù†</label>
      <input id="organization" placeholder="Ù…Ø«Ù„Ø§Ù‹ Ø´Ø±Ú©Øª ÙÙˆÙ„Ø§Ø¯ Ø¢Ø±ÛŒØ§" />

      <div class="row">
        <div class="col">
          <label>Ø§Ø±Ø²ÛŒØ§Ø¨ (ÛŒØ§ ØªÛŒÙ… Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ)</label>
          <input id="evaluator" placeholder="Ù†Ø§Ù… Ø§Ø±Ø²ÛŒØ§Ø¨ ÛŒØ§ Ø§Ø¹Ø¶Ø§ÛŒ ØªÛŒÙ… (Ú©Ø§Ù…Ø§ÛŒÛŒ Ø¬Ø¯Ø§ Ú©Ù†ÛŒØ¯)" />
        </div>
        <div class="col">
          <label>ØªØ§Ø±ÛŒØ® Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ</label>
          <input type="date" id="evaluation_date" />
        </div>
      </div>
    </div>

    <!-- Add / edit criterion -->
    <div class="card">
      <h3>Ø§ÙØ²ÙˆØ¯Ù† ÛŒØ§ ÙˆÛŒØ±Ø§ÛŒØ´ Ø²ÛŒØ±Ù…Ø¹ÛŒØ§Ø±</h3>

      <div class="row">
        <div class="col">
          <label>Ù…Ø¹ÛŒØ§Ø±</label>
          <select id="criterion">
            <option value="1">1 - Purpose, Vision & Strategy</option>
            <option value="2">2 - Organisational Culture & Leadership</option>
            <option value="3">3 - Engaging Stakeholders</option>
            <option value="4">4 - Creating Sustainable Value</option>
            <option value="5">5 - Driving Performance & Transformation</option>
            <option value="6">6 - Stakeholder Perceptions</option>
            <option value="7">7 - Strategic & Operational Performance</option>
          </select>
        </div>

        <div class="col">
          <label>Ø²ÛŒØ±Ù…Ø¹ÛŒØ§Ø± (Ù…Ø«Ù„Ø§Ù‹ 1.1)</label>
          <input id="subcriterion" placeholder="Ù…Ø«Ù„Ø§Ù‹ 1.1" />
        </div>

        <div class="col">
          <label>Ø§Ù…ØªÛŒØ§Ø² (Û°â€“Û±Û°Û°)</label>
          <input type="number" id="score" min="0" max="100" />
        </div>
      </div>

      <hr style="margin:12px 0; border:none; height:1px; background:#eef2f6;" />

      <label>Ù†ØªØ§ÛŒØ¬ (Results)</label>
      <textarea id="results" placeholder="Ø´ÙˆØ§Ù‡Ø¯ Ùˆ Ø´Ø§Ø®Øµâ€ŒÙ‡Ø§"></textarea>

      <label>Ø±ÙˆÛŒÚ©Ø±Ø¯ (Approach)</label>
      <textarea id="approach" placeholder="Ø³ÛŒØ§Ø³Øªâ€ŒÙ‡Ø§ØŒ Ø·Ø±Ø§Ø­ÛŒâ€ŒÙ‡Ø§ Ùˆ Ø±ÙˆØ´â€ŒÙ‡Ø§"></textarea>

      <label>Ø¬Ø§Ø±ÛŒâ€ŒØ³Ø§Ø²ÛŒ (Deployment)</label>
      <textarea id="deployment" placeholder="Ú¯Ø³ØªØ±Ù‡ Ø§Ø¬Ø±Ø§ Ùˆ Ù†Ù…ÙˆÙ†Ù‡â€ŒÙ‡Ø§"></textarea>

      <label>Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ùˆ Ø¨Ù‡Ø¨ÙˆØ¯ (Assessment & Refinement)</label>
      <textarea id="refinement" placeholder="Ù†Ø¸Ø§Ù… Ø¨Ø§Ø²Ø®ÙˆØ±Ø¯ØŒ Ø¨Ø§Ø²Ù†Ú¯Ø±ÛŒ Ùˆ Ø§ØµÙ„Ø§Ø­Ø§Øª"></textarea>

      <hr style="margin:12px 0; border:none; height:1px; background:#eef2f6;" />

      <!-- strengths & opportunities -->
      <div style="display:flex; gap:12px; flex-wrap:wrap;">
        <div style="flex:1 1 420px;">
          <label>Ø§ÙØ²ÙˆØ¯Ù† Ù†Ù‚Ø·Ù‡ Ù‚ÙˆØª</label>
          <div style="display:flex; gap:8px;">
            <input id="strengthInput" placeholder="Ù…Ø«Ù„Ø§Ù‹ Ø³Ø§Ø®ØªØ§Ø± Ø´ÙØ§Ù Ù…Ø³Ø¦ÙˆÙ„ÛŒØªâ€ŒÙ‡Ø§" />
            <button onclick="addStrength()">â•</button>
          </div>
          <ul id="strengthList"></ul>
        </div>

        <div style="flex:1 1 420px;">
          <label>Ø§ÙØ²ÙˆØ¯Ù† ÙØ±ØµØª Ø¨Ù‡Ø¨ÙˆØ¯</label>
          <div style="display:flex; gap:8px;">
            <input id="opportunityInput" placeholder="Ù…Ø«Ù„Ø§Ù‹ ØªÙ‚ÙˆÛŒØª Ù…Ú©Ø§Ù†ÛŒØ²Ù… Ø¨Ø§Ø²Ø®ÙˆØ±Ø¯ Ù…Ø´ØªØ±ÛŒØ§Ù†" />
            <button onclick="addOpportunity()">â•</button>
          </div>
          <ul id="opportunityList"></ul>
        </div>
      </div>

      <div style="margin-top:12px;">
        <button onclick="addCriterion()">âœ… Ø§ÙØ²ÙˆØ¯Ù†/Ø«Ø¨Øª Ø²ÛŒØ±Ù…Ø¹ÛŒØ§Ø±</button>
      </div>
    </div>

    <!-- List of added criteria -->
    <div class="card">
      <h3>Ù…ÙˆØ§Ø±Ø¯ Ø«Ø¨Øª Ø´Ø¯Ù‡</h3>
      <div id="criteriaList"></div>
      <div class="small">Ø¨Ø±Ø§ÛŒ ÙˆÛŒØ±Ø§ÛŒØ´ ÛŒÚ© Ù…ÙˆØ±Ø¯ØŒ Ø¯Ú©Ù…Ù‡ Â«ÙˆÛŒØ±Ø§ÛŒØ´Â» Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯ ØªØ§ Ø¯Ø± ÙØ±Ù… Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´ÙˆØ¯Ø› Ø³Ù¾Ø³ Ù¾Ø³ Ø§Ø² Ø§Ø¹Ù…Ø§Ù„ ØªØºÛŒÛŒØ±Ø§Øª Ù…Ø¬Ø¯Ø¯Ø§Ù‹ Ø°Ø®ÛŒØ±Ù‡ Ú©Ù†ÛŒØ¯.</div>
    </div>

    <!-- Output & preview -->
    <div class="card" id="reportAreaWrap">
      <h3>Ø®Ø±ÙˆØ¬ÛŒ JSON (Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´)</h3>
      <pre id="output">{}</pre>
    </div>

    <footer class="card">
      Â© 2025 Dr. Hamid Eghtedarian â€“ All rights reserved. <br>
      Licensed under <a href="https://github.com/hamideghtedarian/hamideghtedarian/blob/main/README.md" target="_blank">Hamid Eghtedarian Open Evaluation License (HEOEL)</a>
    </footer>
  </div>

<script>
/* ======= Ø¯Ø§Ø¯Ù‡ Ùˆ Ø­Ø§Ù„Øª ======= */
let criteria = []; // array of { id:criterionNumber, subcriteria:[{id:, score:, radar:{...}, strengths:[], opportunities:[]} ] }
let strengths = [];
let opportunities = [];
let editingIndex = null; // if editing an existing subcriterion entry

/* ======= ØªÙˆØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ UI ======= */
function addStrength() {
  const v = document.getElementById("strengthInput").value.trim();
  if (!v) return alert("Ù…ØªÙ† Ù†Ù‚Ø·Ù‡ Ù‚ÙˆØª Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.");
  strengths.push(v);
  renderStrengths();
  document.getElementById("strengthInput").value = "";
}
function addOpportunity() {
  const v = document.getElementById("opportunityInput").value.trim();
  if (!v) return alert("Ù…ØªÙ† ÙØ±ØµØª Ø¨Ù‡Ø¨ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.");
  opportunities.push(v);
  renderOpportunities();
  document.getElementById("opportunityInput").value = "";
}
function renderStrengths() {
  const ul = document.getElementById("strengthList");
  ul.innerHTML = "";
  strengths.forEach((s,i)=> {
    const li=document.createElement("li");
    li.textContent = s + " ";
    const btn=document.createElement("button");
    btn.textContent="Ø­Ø°Ù";
    btn.onclick=()=>{ strengths.splice(i,1); renderStrengths(); };
    btn.style.marginRight="8px";
    li.appendChild(btn);
    ul.appendChild(li);
  });
}
function renderOpportunities() {
  const ul = document.getElementById("opportunityList");
  ul.innerHTML = "";
  opportunities.forEach((s,i)=> {
    const li=document.createElement("li");
    li.textContent = s + " ";
    const btn=document.createElement("button");
    btn.textContent="Ø­Ø°Ù";
    btn.onclick=()=>{ opportunities.splice(i,1); renderOpportunities(); };
    btn.style.marginRight="8px";
    li.appendChild(btn);
    ul.appendChild(li);
  });
}

/* ======= Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø²ÛŒØ±Ù…Ø¹ÛŒØ§Ø± ======= */
function addCriterion() {
  const criterion = parseInt(document.getElementById("criterion").value);
  const subcriterion = document.getElementById("subcriterion").value.trim();
  const scoreRaw = document.getElementById("score").value;
  const score = scoreRaw === "" ? null : Number(scoreRaw);
  if (!subcriterion) return alert("Ù„Ø·ÙØ§Ù‹ Ø´Ù†Ø§Ø³Ù‡/Ø¹Ù†ÙˆØ§Ù† Ø²ÛŒØ±Ù…Ø¹ÛŒØ§Ø± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ (Ù…Ø«Ù„Ø§Ù‹ 1.1).");

  const radar = {
    results: document.getElementById("results").value.trim(),
    approach: document.getElementById("approach").value.trim(),
    deployment: document.getElementById("deployment").value.trim(),
    refinement: document.getElementById("refinement").value.trim()
  };

  const entry = {
    id: criterion,
    subcriteria: [{
      id: subcriterion,
      score,
      radar,
      strengths: [...strengths],
      opportunities: [...opportunities]
    }]
  };

  if (editingIndex !== null) {
    // replace existing entry at editingIndex
    criteria[editingIndex] = entry;
    editingIndex = null;
  } else {
    criteria.push(entry);
  }

  // reset fields
  document.getElementById("subcriterion").value = "";
  document.getElementById("score").value = "";
  document.getElementById("results").value = "";
  document.getElementById("approach").value = "";
  document.getElementById("deployment").value = "";
  document.getElementById("refinement").value = "";
  strengths = []; opportunities = [];
  renderStrengths(); renderOpportunities();
  renderCriteriaList();
  updateOutput();
  alert("âœ… Ø²ÛŒØ±Ù…Ø¹ÛŒØ§Ø± Ø«Ø¨Øª Ø´Ø¯.");
}

/* ======= Ø±Ù†Ø¯Ø± Ù„ÛŒØ³Øª Ø²ÛŒØ±Ù…Ø¹ÛŒØ§Ø±Ù‡Ø§ ======= */
function renderCriteriaList() {
  const wrap = document.getElementById("criteriaList");
  wrap.innerHTML = "";
  if (!criteria.length) { wrap.textContent = "Ù‡Ù†ÙˆØ² Ù…ÙˆØ±Ø¯ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª."; return; }
  criteria.forEach((c, idx) => {
    const div = document.createElement("div");
    div.className = "list-item";
    const left = document.createElement("div");
    left.innerHTML = `<strong>Ù…Ø¹ÛŒØ§Ø± ${c.id}</strong> â€” <span>${c.subcriteria[0].id}</span> â€” Ø§Ù…ØªÛŒØ§Ø²: ${c.subcriteria[0].score ?? "-"}`;
    const right = document.createElement("div");
    right.className = "actions";
    const btnEdit = document.createElement("button"); btnEdit.textContent="ÙˆÛŒØ±Ø§ÛŒØ´"; btnEdit.onclick=()=> loadForEdit(idx);
    const btnDel = document.createElement("button"); btnDel.textContent="Ø­Ø°Ù"; btnDel.className="danger"; btnDel.onclick=()=> { if(confirm("Ø­Ø°Ù Ø´ÙˆØ¯ØŸ")) { criteria.splice(idx,1); renderCriteriaList(); updateOutput(); } };
    right.appendChild(btnEdit); right.appendChild(btnDel);
    div.appendChild(left); div.appendChild(right);
    wrap.appendChild(div);
  });
}

/* ======= Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¢ÛŒØªÙ… Ø¨Ø±Ø§ÛŒ ÙˆÛŒØ±Ø§ÛŒØ´ ======= */
function loadForEdit(index) {
  const item = criteria[index];
  if (!item) return;
  editingIndex = index;
  document.getElementById("criterion").value = item.id;
  const sc = item.subcriteria[0];
  document.getElementById("subcriterion").value = sc.id;
  document.getElementById("score").value = sc.score ?? "";
  document.getElementById("results").value = sc.radar.results || "";
  document.getElementById("approach").value = sc.radar.approach || "";
  document.getElementById("deployment").value = sc.radar.deployment || "";
  document.getElementById("refinement").value = sc.radar.refinement || "";
  strengths = sc.strengths ? [...sc.strengths] : [];
  opportunities = sc.opportunities ? [...sc.opportunities] : [];
  renderStrengths(); renderOpportunities();
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

/* ======= Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ JSON Ø§Ø² ÙØ§ÛŒÙ„ ======= */
document.getElementById("fileInput").addEventListener("change", (e) => {
  const f = e.target.files[0];
  if (!f) return;
  const reader = new FileReader();
  reader.onload = () => {
    try {
      const json = JSON.parse(reader.result);
      loadFromJSON(json);
      alert("âœ… ÙØ§ÛŒÙ„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯ â€” Ø§Ú©Ù†ÙˆÙ† Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ ÙˆÛŒØ±Ø§ÛŒØ´ ÛŒØ§ Ø§Ø¯Ø§Ù…Ù‡ Ø¯Ù‡ÛŒØ¯.");
    } catch (err) {
      alert("Ø®Ø·Ø§ Ø¯Ø± Ø®ÙˆØ§Ù†Ø¯Ù† JSON: " + err.message);
    }
  };
  reader.readAsText(f, "utf-8");
});

/* ======= ØªØ§Ø¨Ø¹ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø³Ø§Ø®ØªØ§Ø± Ø§Ø² JSON ======= */
function loadFromJSON(data) {
  // Ù¾Ø§ÛŒÙ‡â€ŒØ§ÛŒâ€ŒØªØ±ÛŒÙ† Ø§Ù†ØªØ¸Ø§Ø±Ù‡Ø§: organization, evaluator, evaluation_date, criteria_evaluation or criteria
  document.getElementById("organization").value = data.organization || data.company?.name || "";
  document.getElementById("evaluator").value = data.evaluator || (Array.isArray(data.company?.evaluator_team) ? data.company.evaluator_team.join(", ") : "");
  document.getElementById("evaluation_date").value = data.evaluation_date || data.company?.evaluation_date || (new Date()).toISOString().slice(0,10);

  // normalize criteria array: handle different input key names
  if (Array.isArray(data.criteria_evaluation)) {
    criteria = data.criteria_evaluation.map(item => ({
      id: item.id || item.criterion_id || item.criterion || null,
      subcriteria: item.subcriteria ? item.subcriteria : (item.subcriterion ? [item.subcriterion] : (item.subcriteria_evaluations ? item.subcriteria_evaluations : []))
    }));
  } else if (Array.isArray(data.criteria)) {
    // if schema file loaded
    criteria = data.criteria.map(c => ({
      id: c.id,
      subcriteria: c.subcriteria ? c.subcriteria.map(sc=>({ id: sc.id || sc.title, score: sc.score || null, radar: sc.radar || {}, strengths: sc.strengths || [], opportunities: sc.opportunities || [] })) : []
    }));
  } else if (Array.isArray(data.criteria_scores)) {
    // earlier format
    criteria = data.criteria_scores.map(c => ({ id: c.id, subcriteria: c.subcriteria || [] }));
  } else if (Array.isArray(data.evaluation)) {
    criteria = data.evaluation.map(item => ({ id: item.criterion_id ? Number(item.criterion_id.split?.('.')[0] || item.criterion_id) : null, subcriteria:[{
      id: item.criterion_id || item.id || item.subcriterion || "",
      score: item.overall_score ?? item.score ?? null,
      radar: {
        results: item.radar?.results || item.results || "",
        approach: item.radar?.approach || item.approach || "",
        deployment: item.radar?.deployment || item.deployment || "",
        refinement: item.radar?.refinement || item.refinement || ""
      },
      strengths: item.strengths || item.strengths || [],
      opportunities: item.opportunities || item.opportunities || []
    }] }));
  } else {
    // fallback: empty
    criteria = [];
  }

  renderCriteriaList();
  updateOutput();
}

/* ======= ØªÙˆÙ„ÛŒØ¯ Ùˆ Ø¯Ø§Ù†Ù„ÙˆØ¯ JSON ======= */
function getFullJSON() {
  return {
    organization: document.getElementById("organization").value,
    evaluator: document.getElementById("evaluator").value,
    evaluation_date: document.getElementById("evaluation_date").value,
    model_version: "EFQM 2025",
    criteria_evaluation: criteria
  };
}
function downloadJSON() {
  const dataStr = JSON.stringify(getFullJSON(), null, 2);
  const blob = new Blob([dataStr], { type: "application/json;charset=utf-8" });
  const name = (document.getElementById("organization").value || "evaluation").replace(/\s+/g,'-') + ".json";
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = name;
  document.body.appendChild(a);
  a.click();
  a.remove();
}

/* ======= Ø¯Ø§Ù†Ù„ÙˆØ¯ Word (.doc) - HTML wrapper (Word Ù‚Ø§Ø¨Ù„ Ø¨Ø§Ø² Ø´Ø¯Ù†) ======= */
function downloadWord() {
  const html = buildReportHTML();
  const header = "<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'><head><meta charset='utf-8'></head><body>";
  const footer = "</body></html>";
  const blob = new Blob([header + html + footer], { type: "application/msword" });
  const filename = (document.getElementById("organization").value || "evaluation") + ".doc";
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = filename;
  document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=> URL.revokeObjectURL(url), 1000);
}

/* ======= ØªÙˆÙ„ÛŒØ¯ PDF Ø¨Ø§ html2pdf ======= */
function exportPDF() {
  const reportEl = document.createElement("div");
  reportEl.innerHTML = buildReportHTML();
  reportEl.style.direction = "rtl";
  reportEl.style.fontFamily = "Tahoma, Arial, Vazirmatn, sans-serif";
  // Ø¹Ø±Ø¶ ØµÙØ­Ù‡ A4 Ø¯Ø± Ù¾ÛŒÚ©Ø³Ù„ Ø¨Ø±Ø§ÛŒ html2pdf ØªÙ‚Ø±ÛŒØ¨ÛŒ Ø§Ø³ØªØ› ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ú©ÛŒÙÛŒØª
  const opt = {
    margin: 12,
    filename: (document.getElementById("organization").value || "evaluation") + ".pdf",
    image: { type: 'jpeg', quality: 0.98 },
    html2canvas: { scale: 2, useCORS: true },
    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
  };
  // Ù†Ù…Ø§ÛŒØ´ Ù…ÙˆÙ‚Øª Ø¯Ø± ØµÙØ­Ù‡ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ) ÛŒØ§ Ø§Ø±Ø³Ø§Ù„ Ù…Ø³ØªÙ‚ÛŒÙ… Ø¨Ù‡ html2pdf
  html2pdf().set(opt).from(reportEl).save();
}

/* ======= Ø³Ø§Ø®Øª HTML Ú¯Ø²Ø§Ø±Ø´ (Ø¨Ø±Ø§ÛŒ PDF/Word) ======= */
function buildReportHTML() {
  const org = document.getElementById("organization").value || "";
  const evaluator = document.getElementById("evaluator").value || "";
  const date = document.getElementById("evaluation_date").value || "";

  // header with banner & logo (use remote images)
  const header = `
    <div style="text-align:center; margin-bottom:12px;">
      <img src="https://raw.githubusercontent.com/hamideghtedarian/hamideghtedarian/main/banner.png" style="max-width:100%; height:auto;" alt="banner" />
    </div>
    <div style="text-align:center; margin-bottom:6px;">
      <img src="https://raw.githubusercontent.com/hamideghtedarian/hamideghtedarian/main/logo.png" style="width:110px; height:auto;" alt="logo" />
    </div>
    <h2 style="text-align:center; margin:6px 0 12px 0; color:#004080;">Ú¯Ø²Ø§Ø±Ø´ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ EFQM 2025</h2>
    <div style="margin-bottom:10px; font-size:14px;"><strong>Ø³Ø§Ø²Ù…Ø§Ù†:</strong> ${escapeHtml(org)} &nbsp;&nbsp; | &nbsp;&nbsp; <strong>Ø§Ø±Ø²ÛŒØ§Ø¨:</strong> ${escapeHtml(evaluator)} &nbsp;&nbsp; | &nbsp;&nbsp; <strong>ØªØ§Ø±ÛŒØ®:</strong> ${escapeHtml(date)}</div>
    <hr />
  `;

  // body with criteria table
  let body = "";
  if (!criteria.length) {
    body += `<p>Ù‡ÛŒÚ† Ø²ÛŒØ±Ù…Ø¹ÛŒØ§Ø±ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>`;
  } else {
    criteria.forEach((c, i) => {
      const sc = c.subcriteria[0];
      body += `<section style="margin-bottom:14px; padding:8px; border-radius:8px; border:1px solid #e8eef4;">
        <h3 style="margin:6px 0;">Ù…Ø¹ÛŒØ§Ø± ${escapeHtml(String(c.id))} â€” ${escapeHtml(sc.id)}</h3>
        <p><strong>Ø§Ù…ØªÛŒØ§Ø²:</strong> ${sc.score ?? "-"}</p>
        <table style="width:100%; border-collapse:collapse; margin-top:8px;">
          <tr><td style="width:25%; vertical-align:top; padding:6px;"><strong>Results</strong></td><td style="padding:6px;">${escapeHtml(sc.radar.results)}</td></tr>
          <tr><td style="width:25%; vertical-align:top; padding:6px;"><strong>Approach</strong></td><td style="padding:6px;">${escapeHtml(sc.radar.approach)}</td></tr>
          <tr><td style="width:25%; vertical-align:top; padding:6px;"><strong>Deployment</strong></td><td style="padding:6px;">${escapeHtml(sc.radar.deployment)}</td></tr>
          <tr><td style="width:25%; vertical-align:top; padding:6px;"><strong>Assessment & Refinement</strong></td><td style="padding:6px;">${escapeHtml(sc.radar.refinement)}</td></tr>
        </table>
        <div style="margin-top:8px;">
          <strong>Ù†Ù‚Ø§Ø· Ù‚ÙˆØª:</strong>
          <ul>${(sc.strengths || []).map(s => `<li>${escapeHtml(s)}</li>`).join("")}</ul>
          <strong>ÙØ±ØµØªâ€ŒÙ‡Ø§ÛŒ Ø¨Ù‡Ø¨ÙˆØ¯:</strong>
          <ul>${(sc.opportunities || []).map(s => `<li>${escapeHtml(s)}</li>`).join("")}</ul>
        </div>
      </section>`;
    });
  }

  const footer = `
    <hr />
    <div style="font-size:12px; color:#666; margin-top:8px;">
      <p>Â© 2025 Dr. Hamid Eghtedarian â€“ All rights reserved.</p>
      <p>Licensed under <a href="https://github.com/hamideghtedarian/hamideghtedarian/blob/main/README.md">Hamid Eghtedarian Open Evaluation License (HEOEL)</a></p>
    </div>
  `;

  return header + body + footer;
}

/* ======= Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ JSON ======= */
function updateOutput() {
  document.getElementById("output").textContent = JSON.stringify(getFullJSON(), null, 2);
}

/* ======= Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ ÙØ±Ù… ======= */
function clearAll() {
  if (!confirm("Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù†ÛŒØ¯ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ ÙØ±Ù… Ø±Ø§ Ù¾Ø§Ú© Ú©Ù†ÛŒØ¯ØŸ")) return;
  document.getElementById("organization").value = "";
  document.getElementById("evaluator").value = "";
  document.getElementById("evaluation_date").value = "";
  document.getElementById("subcriterion").value = "";
  document.getElementById("score").value = "";
  document.getElementById("results").value = "";
  document.getElementById("approach").value = "";
  document.getElementById("deployment").value = "";
  document.getElementById("refinement").value = "";
  strengths = []; opportunities = []; criteria = []; editingIndex = null;
  renderStrengths(); renderOpportunities(); renderCriteriaList(); updateOutput();
}

/* ======= ØªØ§Ø¨Ø¹ ÙØ±Ø§Ø± Ø§Ø² Ú©Ø§Ø±Ø§Ú©ØªØ±Ù‡Ø§ÛŒ HTML Ø¨Ø±Ø§ÛŒ Ø®Ø±ÙˆØ¬ÛŒ Ø§Ù…Ù† ======= */
function escapeHtml(text) {
  if (text === null || text === undefined) return "";
  return String(text).replace(/[&<>"'`=\/]/g, function(s) {
    return ({
      '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;', '/': '&#x2F;', '`':'&#x60;', '=':'&#x3D;'
    })[s];
  });
}

/* ======= initialize ======= */
renderCriteriaList();
updateOutput();

</script>
</body>
</html>
