<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ EFQM 2025 â€” ÙØ±Ù… Ø²ÛŒØ±Ù…Ø¹ÛŒØ§Ø±Ù‡Ø§</title>
  <style>
    body{font-family: Vazirmatn, Tahoma, Arial; background:#f6f8fb; color:#222; padding:18px;}
    .card{background:#fff; border-radius:10px; padding:16px; box-shadow:0 6px 20px rgba(0,0,0,0.06); margin-bottom:14px;}
    label{display:block; font-weight:600; margin-top:8px;}
    input[type=text], input[type=date], select, textarea, input[type=number]{
      width:100%; padding:8px; border-radius:8px; border:1px solid #d6dbe0; margin-top:6px;
    }
    textarea{min-height:70px;}
    .row{display:flex; gap:12px; flex-wrap:wrap;}
    .col{flex:1 1 300px;}
    button{background:#0059b3; color:#fff; border:none; padding:10px 14px; border-radius:8px; cursor:pointer;}
    button.secondary{background:#6c757d;}
    button.danger{background:#c9302c;}
    table{width:100%; border-collapse:collapse; margin-top:8px;}
    th, td{padding:8px; border:1px solid #eef2f6; text-align:right;}
    .small{font-size:13px; color:#666;}
    .inline{display:inline-block;}
    .badge{background:#e6f0ff; color:#004080; padding:4px 8px; border-radius:12px; font-weight:600;}
  </style>
</head>
<body>

  <div class="card">
    <h2>Ø´Ù†Ø§Ø³Ù†Ø§Ù…Ù‡ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ</h2>
    <label>Ù†Ø§Ù… Ø³Ø§Ø²Ù…Ø§Ù†</label>
    <input id="orgName" placeholder="Ù…Ø«Ù„Ø§Ù‹ Ø´Ø±Ú©Øª ÙÙˆÙ„Ø§Ø¯ Ø¢Ø±ÛŒØ§" />

    <div class="row">
      <div class="col">
        <label>ØªØ§Ø±ÛŒØ® Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ</label>
        <input type="date" id="evalDate" />
      </div>
      <div class="col">
        <label>ØªÛŒÙ… Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ (Ø¨Ø§ Ú©Ø§Ù…Ø§ Ø¬Ø¯Ø§ Ú©Ù†ÛŒØ¯)</label>
        <input id="evalTeam" placeholder="Ù†Ø§Ù… Ø§ÙØ±Ø§Ø¯ØŒ Ù…Ø«Ø§Ù„: Ø¹Ù„ÛŒØŒ Ø±Ø¶Ø§ØŒ Ù†Ø³Ø±ÛŒÙ†" />
      </div>
    </div>

    <div style="margin-top:10px;">
      <label>Ø§Ù†ØªØ®Ø§Ø¨ Ù…Ø¯Ù„ EFQM (ÙØ§ÛŒÙ„ Ù…Ø¯Ù„ Ø¨Ø§ÛŒØ¯ Ø¯Ø± data/efqm2025.json Ù‚Ø±Ø§Ø± Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯)</label>
      <input id="modelPath" value="../data/efqm2025.json" />
      <div class="small">Ø¯Ø± ØµÙˆØ±Øª Ù†ÛŒØ§Ø² Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ù…Ø³ÛŒØ± Ø±Ø§ ØªØºÛŒÛŒØ± Ø¯Ù‡ÛŒØ¯.</div>
    </div>
  </div>

  <div class="card">
    <h2>Ø§ÙØ²ÙˆØ¯Ù† / ÙˆÛŒØ±Ø§ÛŒØ´ Ø²ÛŒØ±Ù…Ø¹ÛŒØ§Ø± (Ø¨Ø±Ø§Ø³Ø§Ø³ EFQM 2025)</h2>

    <label>Ø²ÛŒØ±Ù…Ø¹ÛŒØ§Ø± (Ø§Ø² Ù…Ø¯Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´ÙˆØ¯)</label>
    <select id="subSelect"><option>Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</option></select>
<div id="criterionTooltip" style="margin-top:10px;"></div>

    <label>Ø§Ù…ØªÛŒØ§Ø² Ø²ÛŒØ±Ù…Ø¹ÛŒØ§Ø± (Û°â€“Û±Û°Û°)</label>
    <input type="number" id="score" min="0" max="100" />

    <label>Results (Ù†ØªØ§ÛŒØ¬)</label>
    <textarea id="results"></textarea>

    <label>Approach (Ø±ÙˆÛŒÚ©Ø±Ø¯)</label>
    <textarea id="approach"></textarea>

    <label>Deployment (Ø¬Ø§Ø±ÛŒâ€ŒØ³Ø§Ø²ÛŒ)</label>
    <textarea id="deployment"></textarea>

    <label>Assessment & Refinement (Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ùˆ Ø¨Ù‡Ø¨ÙˆØ¯)</label>
    <textarea id="refinement"></textarea>

    <label>Ù†Ù‚Ø§Ø· Ù‚ÙˆØª (Ù‡Ø± Ø®Ø· ÛŒÚ© Ù…ÙˆØ±Ø¯)</label>
    <textarea id="strengths"></textarea>

    <label>ÙØ±ØµØªâ€ŒÙ‡Ø§ÛŒ Ø¨Ù‡Ø¨ÙˆØ¯ (Ù‡Ø± Ø®Ø· ÛŒÚ© Ù…ÙˆØ±Ø¯)</label>
    <textarea id="opportunities"></textarea>

    <div style="margin-top:10px;">
      <button onclick="addOrUpdateEntry()">â• Ø§ÙØ²ÙˆØ¯Ù†/Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø²ÛŒØ±Ù…Ø¹ÛŒØ§Ø±</button>
      <button class="secondary" onclick="clearEntry()">Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ÙÛŒÙ„Ø¯Ù‡Ø§</button>
    </div>
  </div>

  <div class="card">
    <h2>Ù…ÙˆØ§Ø±Ø¯ Ø«Ø¨Øªâ€ŒØ´Ø¯Ù‡</h2>
    <div id="summaryBadges" style="margin-bottom:10px;"></div>
    <div id="entriesWrap">Ù‡Ù†ÙˆØ² Ù…ÙˆØ±Ø¯ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</div>
  </div>

  <div class="card">
    <h2>Ø®Ø±ÙˆØ¬ÛŒ / Ø°Ø®ÛŒØ±Ù‡</h2>
    <div class="row">
      <div class="col">
        <label>Ø°Ø®ÛŒØ±Ù‡ Ù…Ø­Ù„ÛŒ (Local)</label>
        <button onclick="saveLocal()">ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Ù…Ø±ÙˆØ±Ú¯Ø±</button>
        <button onclick="downloadJSON()">â¬‡ Ø¯Ø§Ù†Ù„ÙˆØ¯ JSON</button>
        <input type="file" id="loadFileInput" style="margin-top:10px;" />
        <div class="small">Ø¨Ø±Ø§ÛŒ Ø§Ø¯Ø§Ù…Ù‡ Ú©Ø§Ø±ØŒ ÙØ§ÛŒÙ„ Ø°Ø®ÛŒØ±Ù‡â€ŒØ´Ø¯Ù‡ Ø±Ø§ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ù†ÛŒØ¯.</div>
      </div>
      <div class="col">
        <label>Ø°Ø®ÛŒØ±Ù‡ Ù…Ø³ØªÙ‚ÛŒÙ… Ø¯Ø± GitHub (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label>
        <input id="ghToken" placeholder="Paste a GitHub Personal Access Token (ghp_...)" />
        <input id="ghFilename" placeholder="Ù†Ø§Ù… ÙØ§ÛŒÙ„ Ø¯Ø± repo (Ù…Ø«Ù„Ø§Ù‹ foolad-arya.json)" style="margin-top:6px;" />
        <div style="margin-top:8px;">
          <button onclick="saveToGitHub()">ğŸ“¡ Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± GitHub</button>
          <div class="small">Ø¢Ø¯Ø±Ø³ Ø°Ø®ÛŒØ±Ù‡â€ŒØ´Ø¯Ù‡: <span id="ghTargetPath" class="badge"></span></div>
          <div class="small">(ØªÙˆØ¬Ù‡: Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ø§Ù…Ù†â€ŒØªØ± Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² GitHub Actions Ø§Ø³Øª â€” ØªÙˆÚ©Ù† Ø±Ø§ Ø¯Ø± Ù…Ø±ÙˆØ±Ú¯Ø± Ù†Ú¯Ù‡ Ù†Ø¯Ø§Ø±ÛŒØ¯.)</div>
        </div>
      </div>
    </div>

    <h3 style="margin-top:12px;">Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ JSON</h3>
    <pre id="output" style="max-height:320px; overflow:auto; background:#f2f6fb; padding:10px; border-radius:8px;">{}</pre>
  </div>

<script>
/* ======= Ø­Ø§Ù„Øª Ùˆ Ø¯Ø§Ø¯Ù‡ Ù‡Ø§ ======= */
let model = null; // efqm2025.json content
let entries = []; // list of { subId, criterionId, score, radar:{...}, strengths:[], opportunities:[] }
let editingIndex = null;

/* ======= Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…Ø¯Ù„ Ø§Ø² Ù…Ø³ÛŒØ± Ø¯Ø§Ø¯Ù‡ Ø´Ø¯Ù‡ ======= */
async function loadModel() {
  const path = document.getElementById('modelPath').value;
  try {
    const resp = await fetch(path);
    if (!resp.ok) throw new Error('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…Ø¯Ù„: ' + resp.status);
    model = await resp.json();
    populateSubcriteria();
    console.log('Model loaded', model);
  } catch (err) {
    alert('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…Ø¯Ù„: ' + err.message + '\nÙ„Ø·ÙØ§Ù‹ Ù…Ø³ÛŒØ± ÙØ§ÛŒÙ„ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯.');
    document.getElementById('subSelect').innerHTML = '<option>Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…Ø¯Ù„</option>';
  }
}
/* ======= Ù¾Ø± Ú©Ø±Ø¯Ù† Ù„ÛŒØ³Øª Ø²ÛŒØ±Ù…Ø¹ÛŒØ§Ø±Ù‡Ø§ Ø¨Ø§ Tooltip ======= */
function populateSubcriteria(){
  const sel = document.getElementById('subSelect');
  sel.innerHTML = '';
  if(!model || !Array.isArray(model.criteria)) {
    sel.innerHTML = '<option>Ù…Ø¯Ù„ Ù†Ø§Ù…Ø¹ØªØ¨Ø±</option>';
    return;
  }

  model.criteria.forEach(c=>{
    if(Array.isArray(c.subcriteria)) {
      // Ú¯Ø±ÙˆÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ø¨Ø§ optgroup Ø¨Ø± Ø§Ø³Ø§Ø³ Ù…Ø¹ÛŒØ§Ø±
      const group = document.createElement('optgroup');
      group.label = `${c.id} - ${c.title_fa}`;
      c.subcriteria.forEach(sc=>{
        const opt = document.createElement('option');
        opt.value = sc.id;
        opt.dataset.criterionId = c.id;
        opt.dataset.description = sc.description || "";
        opt.dataset.title_en = sc.title_en || "";
        opt.dataset.title_fa = sc.title_fa || "";
        opt.textContent = `${sc.id} - ${sc.title_fa}`;
        group.appendChild(opt);
      });
      sel.appendChild(group);
    }
  });

  // Ù†Ù…Ø§ÛŒØ´ Tooltip Ù‡Ù†Ú¯Ø§Ù… Ø§Ù†ØªØ®Ø§Ø¨
  sel.addEventListener('change', showTooltipForSelected);
}

/* ======= Ù†Ù…Ø§ÛŒØ´ Tooltip ØªÙˆØ¶ÛŒØ­ Ø²ÛŒØ±Ù…Ø¹ÛŒØ§Ø± ======= */
function showTooltipForSelected(){
  const sel = document.getElementById('subSelect');
  const selected = sel.selectedOptions[0];
  if(!selected) return;
  const desc = selected.dataset.description || "";
  const titleEn = selected.dataset.title_en || "";
  const titleFa = selected.dataset.title_fa || "";
  const tooltip = document.getElementById('criterionTooltip');
  tooltip.innerHTML = `
    <div style="background:#f1f5ff;border-radius:10px;padding:10px;margin-top:8px;">
      <b>${selected.value}</b> â€” <span style="color:#004080;">${titleEn}</span><br>
      <span>${titleFa}</span><br>
      <small style="color:#333;">${desc}</small>
    </div>`;
}

/* ======= Ù¾Ø± Ú©Ø±Ø¯Ù† Ù„ÛŒØ³Øª Ø²ÛŒØ±Ù…Ø¹ÛŒØ§Ø±Ù‡Ø§ ======= */
function populateSubcriteria(){
  const sel = document.getElementById('subSelect');
  sel.innerHTML = '';
  if(!model || !Array.isArray(model.criteria)) {
    sel.innerHTML = '<option>Ù…Ø¯Ù„ Ù†Ø§Ù…Ø¹ØªØ¨Ø±</option>';
    return;
  }
  model.criteria.forEach(c=>{
    if(Array.isArray(c.subcriteria)) {
      c.subcriteria.forEach(sc=>{
        const opt = document.createElement('option');
        // Ù†Ù…Ø§ÛŒØ´: 1.1 â€” Ø¹Ù†ÙˆØ§Ù† ÙØ§Ø±Ø³ÛŒ â€” (Ø¹Ù†ÙˆØ§Ù† Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ Ú©ÙˆØªØ§Ù‡)
        opt.value = sc.id;
        const fa = sc.title_fa || sc.title_en || sc.id;
        const en = sc.title_en ? ` â€” ${sc.title_en}` : '';
        opt.textContent = `${sc.id} - ${fa}${en}`;
        opt.dataset.criterionId = c.id;
        sel.appendChild(opt);
      });
    }
  });
}

/* ======= Ø§ÙØ²ÙˆØ¯Ù†/Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÛŒÚ© ÙˆØ±ÙˆØ¯ÛŒ ======= */
function addOrUpdateEntry(){
  const subId = document.getElementById('subSelect').value;
  if(!subId) return alert('Ù„Ø·ÙØ§Ù‹ ÛŒÚ© Ø²ÛŒØ±Ù…Ø¹ÛŒØ§Ø± Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.');
  const opt = document.getElementById('subSelect').selectedOptions[0];
  const criterionId = opt ? opt.dataset.criterionId : null;
  const scoreVal = document.getElementById('score').value;
  const score = scoreVal==="" ? null : Number(scoreVal);
  const radar = {
    results: document.getElementById('results').value,
    approach: document.getElementById('approach').value,
    deployment: document.getElementById('deployment').value,
    refinement: document.getElementById('refinement').value
  };
  const strengths = document.getElementById('strengths').value.split('\n').map(s=>s.trim()).filter(Boolean);
  const opportunities = document.getElementById('opportunities').value.split('\n').map(s=>s.trim()).filter(Boolean);

  const entry = { subId, criterionId: Number(criterionId), score, radar, strengths, opportunities, updated: new Date().toISOString() };

  if(editingIndex !== null) {
    entries[editingIndex] = entry;
    editingIndex = null;
  } else {
    entries.push(entry);
  }
  renderEntries();
  clearEntry();
}

/* ======= Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ ÙØ±Ù… ÙˆØ±ÙˆØ¯ Ø²ÛŒØ±Ù…Ø¹ÛŒØ§Ø± ======= */
function clearEntry(){
  document.getElementById('score').value = '';
  document.getElementById('results').value = '';
  document.getElementById('approach').value = '';
  document.getElementById('deployment').value = '';
  document.getElementById('refinement').value = '';
  document.getElementById('strengths').value = '';
  document.getElementById('opportunities').value = '';
  editingIndex = null;
}

/* ======= Ø±Ù†Ø¯Ø± Ù„ÛŒØ³Øª Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§ Ùˆ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù†Ù…Ø±Ø§Øª Ù…Ø¹ÛŒØ§Ø±Ù‡Ø§ ======= */
function renderEntries(){
  const wrap = document.getElementById('entriesWrap');
  if(entries.length === 0) { wrap.innerHTML = '<div class="small">Ù‡Ù†ÙˆØ² Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</div>'; updateOutput(); return; }

  // Group by criterion
  const byCrit = {};
  entries.forEach((e, idx) => {
    if(!byCrit[e.criterionId]) byCrit[e.criterionId]=[];
    byCrit[e.criterionId].push({...e, idx});
  });

  let html = '';
  html += '<table><thead><tr><th>Ù…Ø¹ÛŒØ§Ø±</th><th>Ø²ÛŒØ±Ù…Ø¹ÛŒØ§Ø±</th><th>Ø§Ù…ØªÛŒØ§Ø²</th><th>Ù†Ù‚Ø§Ø· Ù‚ÙˆØª</th><th>ÙØ±ØµØªâ€ŒÙ‡Ø§</th><th>Ø¹Ù…Ù„ÛŒØ§Øª</th></tr></thead><tbody>';
  Object.keys(byCrit).forEach(cid=>{
    const list = byCrit[cid];
    list.forEach(item=>{
      html += `<tr>
        <td>${cid}</td>
        <td>${item.subId}</td>
        <td>${item.score===null? '-' : item.score}</td>
        <td>${(item.strengths||[]).map(s=>escapeHtml(s)).join('<br>')}</td>
        <td>${(item.opportunities||[]).map(s=>escapeHtml(s)).join('<br>')}</td>
        <td>
          <button onclick="editEntry(${item.idx})">ÙˆÛŒØ±Ø§ÛŒØ´</button>
          <button class="danger" onclick="deleteEntry(${item.idx})">Ø­Ø°Ù</button>
        </td>
      </tr>`;
    });
    // criterion aggregate
    const avg = computeCriterionAverage(cid);
    html += `<tr style="background:#fbfbfd"><td colspan="2" style="font-weight:700">Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ù…Ø¹ÛŒØ§Ø± ${cid}</td><td colspan="4" style="font-weight:700">${avg===null? '-' : avg.toFixed(2)}</td></tr>`;
  });
  html += '</tbody></table>';
  wrap.innerHTML = html;
  renderSummaryBadges();
  updateOutput();
}

/* ======= ÙˆÛŒØ±Ø§ÛŒØ´ / Ø­Ø°Ù ======= */
function editEntry(idx){
  const e = entries[idx];
  if(!e) return;
  editingIndex = idx;
  // select option
  for(let i=0;i<document.getElementById('subSelect').options.length;i++){
    if(document.getElementById('subSelect').options[i].value === e.subId){
      document.getElementById('subSelect').selectedIndex = i; break;
    }
  }
  document.getElementById('score').value = e.score===null? '' : e.score;
  document.getElementById('results').value = e.radar.results || '';
  document.getElementById('approach').value = e.radar.approach || '';
  document.getElementById('deployment').value = e.radar.deployment || '';
  document.getElementById('refinement').value = e.radar.refinement || '';
  document.getElementById('strengths').value = (e.strengths||[]).join('\n');
  document.getElementById('opportunities').value = (e.opportunities||[]).join('\n');
  window.scrollTo({top:0, behavior:'smooth'});
}
function deleteEntry(idx){
  if(!confirm('Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ')) return;
  entries.splice(idx,1);
  renderEntries();
}

/* ======= Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† ÛŒÚ© Ù…Ø¹ÛŒØ§Ø± ======= */
function computeCriterionAverage(criterionId){
  const list = entries.filter(e=>String(e.criterionId) === String(criterionId));
  const scores = list.map(l=>Number(l.score)).filter(n=>!isNaN(n));
  if(scores.length===0) return null;
  const sum = scores.reduce((a,b)=>a+b,0);
  return sum / scores.length;
}

/* ======= Ù†Ù…Ø§ÛŒØ´ Ø®Ù„Ø§ØµÙ‡ Ø¨Ø±Ø§ÛŒ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ú©ÙˆÚ†Ú© ======= */
function renderSummaryBadges(){
  const el = document.getElementById('summaryBadges');
  el.innerHTML = '';
  const critIds = [...new Set(entries.map(e=>e.criterionId))];
  critIds.forEach(cid=>{
    const avg = computeCriterionAverage(cid);
    const span = document.createElement('span');
    span.className = 'badge';
    span.textContent = `Ù…Ø¹ÛŒØ§Ø± ${cid}: ${avg===null? '-' : avg.toFixed(1)}`;
    el.appendChild(span);
    el.appendChild(document.createTextNode(' '));
  });
}

/* ======= Ø®Ø±ÙˆØ¬ÛŒ JSON Ú©Ø§Ù…Ù„ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ ======= */
function buildFullJSON(){
  const metadata = {
    organization: document.getElementById('orgName').value || '',
    evaluation_date: document.getElementById('evalDate').value || (new Date()).toISOString().slice(0,10),
    evaluator_team: document.getElementById('evalTeam').value.split(',').map(s=>s.trim()).filter(Boolean),
    model_version: 'EFQM 2025',
    generated_at: new Date().toISOString()
  };
  // group entries by criterion for clarity
  const grouped = {};
  entries.forEach(e=>{
    if(!grouped[e.criterionId]) grouped[e.criterionId]=[];
    grouped[e.criterionId].push(e);
  });
  const criteria = Object.keys(grouped).map(cid=>{
    return {
      criterion_id: Number(cid),
      average_score: computeCriterionAverage(cid),
      subcriteria: grouped[cid]
    };
  });
  return { metadata, criteria, raw_entries: entries };
}

/* ======= Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ JSON ======= */
function updateOutput(){
  const json = buildFullJSON();
  document.getElementById('output').textContent = JSON.stringify(json, null, 2);
}

/* ======= Ø°Ø®ÛŒØ±Ù‡ Ù…Ø­Ù„ÛŒ ======= */
function saveLocal(){
  const key = 'efqm_evaluation_local';
  localStorage.setItem(key, JSON.stringify(buildFullJSON()));
  alert('Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¯Ø± Ù…Ø±ÙˆØ±Ú¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯ (localStorage).');
}

/* ======= Ø¯Ø§Ù†Ù„ÙˆØ¯ JSON ======= */
function downloadJSON(){
  const json = buildFullJSON();
  const blob = new Blob([JSON.stringify(json, null, 2)], {type:'application/json;charset=utf-8'});
  const name = (json.metadata.organization || 'evaluation').replace(/\s+/g,'_') + '.json';
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = name;
  document.body.appendChild(a); a.click(); a.remove();
}

/* ======= Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø² ÙØ§ÛŒÙ„ JSON (Ø§Ø¯Ø§Ù…Ù‡/ÙˆÛŒØ±Ø§ÛŒØ´) ======= */
document.getElementById('loadFileInput').addEventListener('change', (ev)=>{
  const f = ev.target.files[0];
  if(!f) return;
  const r = new FileReader();
  r.onload = ()=>{
    try {
      const obj = JSON.parse(r.result);
      // try to map structure: metadata + criteria or raw_entries
      if(obj.raw_entries) {
        entries = obj.raw_entries;
      } else if(Array.isArray(obj.criteria)) {
        // reconstruct raw entries
        entries = [];
        obj.criteria.forEach(c=>{
          (c.subcriteria||[]).forEach(sc=> entries.push(sc));
        });
      } else {
        alert('ÙØ±Ù…Øª ÙØ§ÛŒÙ„ Ù†Ø§Ù…Ø´Ø®Øµ Ø§Ø³Øª. Ù„Ø·ÙØ§Ù‹ ÙØ§ÛŒÙ„ Ø®Ø±ÙˆØ¬ÛŒ ØµØ­ÛŒØ­ Ø±Ø§ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ù†ÛŒØ¯.');
        return;
      }
      // populate metadata
      if(obj.metadata){
        document.getElementById('orgName').value = obj.metadata.organization || '';
        document.getElementById('evalDate').value = obj.metadata.evaluation_date || '';
        document.getElementById('evalTeam').value = (obj.metadata.evaluator_team||[]).join(', ');
      }
      renderEntries();
      alert('âœ… ÙØ§ÛŒÙ„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ùˆ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ ÙˆØ§Ø±Ø¯ Ø´Ø¯Ù†Ø¯.');
    } catch(err){
      alert('Ø®Ø·Ø§ Ø¯Ø± Ø®ÙˆØ§Ù†Ø¯Ù† ÙØ§ÛŒÙ„: ' + err.message);
    }
  };
  r.readAsText(f, 'utf-8');
});

/* ======= Ø°Ø®ÛŒØ±Ù‡ Ù…Ø³ØªÙ‚ÛŒÙ… Ø¯Ø± GitHub (Ø¨Ø§ PAT Ú©Ø§Ø±Ø¨Ø±) =======
  Ø±ÙˆØ´: Ø§Ø¨ØªØ¯Ø§ ÙØ§ÛŒÙ„ Ø±Ø§ Ø¨Ù‡ ØµÙˆØ±Øª base64 Ø¯Ø± Ù…Ø³ÛŒØ± data/companies/{filename} Ø§ÛŒØ¬Ø§Ø¯/Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ….
  ØªÙˆØ¬Ù‡ Ø§Ù…Ù†ÛŒØªÛŒ: Ø¨Ù‡ØªØ± Ø§Ø³Øª Ø§Ø² GitHub Actions Ø¨Ø±Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ø§Ù…Ù† Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯Ø› Ø§Ø±Ø³Ø§Ù„ ØªÙˆÚ©Ù† Ø¯Ø± Ø§ÛŒÙ† ÙØ±Ù… Ø¨Ù‡ Ù…Ø¹Ù†ÛŒ
  Ù†Ú¯Ù‡Ø¯Ø§Ø±ÛŒ Ù…ÙˆÙ‚Øª Ø¢Ù† Ø¯Ø± Ø­Ø§ÙØ¸Ù‡ Ù…Ø±ÙˆØ±Ú¯Ø± Ø§Ø³Øª.
*/
async function saveToGitHub(){
  const token = document.getElementById('ghToken').value.trim();
  const filename = document.getElementById('ghFilename').value.trim();
  if(!token || !filename) return alert('Ù„Ø·ÙØ§Ù‹ ØªÙˆÚ©Ù† Ùˆ Ù†Ø§Ù… ÙØ§ÛŒÙ„ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.');
  const owner = 'hamideghtedarian'; // ØªØºÛŒÛŒØ± Ø¯Ù‡ÛŒØ¯ Ø§Ú¯Ø± Ù„Ø§Ø²Ù… Ø§Ø³Øª
  const repo = 'efqm2025-evaluation-system';
  const path = `data/companies/${filename}`;
  document.getElementById('ghTargetPath').textContent = path;

  const contentStr = JSON.stringify(buildFullJSON(), null, 2);
  const contentB64 = btoa(unescape(encodeURIComponent(contentStr)));

  const api = `https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(path)}`;

  // check if file exists to get sha (for update)
  let sha = null;
  try {
    const headResp = await fetch(api, { headers: { Authorization: 'token ' + token, Accept: 'application/vnd.github.v3+json' } });
    if(headResp.status === 200){
      const headJson = await headResp.json();
      sha = headJson.sha;
    }
  } catch(e){
    // ignore
  }

  const body = { message: `Add/update evaluation ${filename}`, content: contentB64, branch: 'main' };
  if(sha) body.sha = sha;

  const putResp = await fetch(api, {
    method: 'PUT',
    headers: { Authorization: 'token ' + token, Accept: 'application/vnd.github.v3+json', 'Content-Type':'application/json' },
    body: JSON.stringify(body)
  });
  if(putResp.ok){
    alert('âœ… ÙØ§ÛŒÙ„ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¯Ø± GitHub Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯.');
  } else {
    const txt = await putResp.text();
    alert('Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± GitHub: ' + putResp.status + ' - ' + txt);
  }
}

/* ======= ÛŒÙˆØªÛŒÙ„â€ŒÙ‡Ø§ ======= */
function escapeHtml(s){
  if(!s) return '';
  return String(s).replace(/[&<>"'`=\/]/g, function(ch){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;'}[ch]; });
}

/* ======= initialize ======= */
document.getElementById('evalDate').value = new Date().toISOString().slice(0,10);
loadModel();
renderEntries();

</script>
</body>
</html>
